ifeq ($(MAKECMDGOALS),$(filter $(MAKECMDGOALS),all opt byte)) 
  CLEANING := 1
endif

all : opt

opt : oldclean 
	./make.sh opt

byte : oldclean 
	./make.sh byte

clean : oldclean 
	./make.sh clean

# 
# Makefile for building goblint.
#
# Popular targets: all=opt test clean docs unittests
#

VRSNHACK := $(shell scripts/set_version.sh)

CIL=@CIL@
CILLIB=@CIL@/@CILOBJ@
XML=@XML@
EXE=@EXE@

LINK_LIBS  = @LINKLIBS@ bigarray camomile batteries
CAMLDIR    = @CAMLDIR@ 
OCAMLDOC   = @OCAMLDOC@

OBJDIR     = obj
DEPENDDIR  = obj/.depend
SOURCEDIRS = src/ src/util/ src/domains/ src/cdomains/ src/framework/ \
             src/solvers/ src/analyses/ unittest/ unittest/solver \
             unittest/cdomains unittest/domains src/util/html_template/

COMPILEFLAGS = @COMPILEFLAGS@ -I $(CILLIB)  
LINKFLAGS = @COMPILEFLAGS@ -ccopt -L$(CILLIB) -I $(CILLIB)  
DOCFLAGS = @DOCFLAGS@ -stars -t 'Goblint API documentation' -dot-reduce -dot -html -d doc -v

PROG_MODULES = \
	version config json jsonParser jsonLexer htmlutil css_template js_template stylesheet script \
	goblintutil messages printer cilfacade myCFG xmldump gobConfig \
	printable lattice setDomain mapDomain osektupel \
	basetype intDomain lval addressDomain arrayDomain listDomain htmldump \
	structDomain unionDomain valueDomain exp queries partitionDomain memoryDomain \
	musteqDomain regionDomain concDomain lockDomain  baseDomain escapeDomain \
	accessDomain containDomain myLiveness shapeDomain stackDomain \
	hash progress analyses libraryFunctions glob cache generic \
	solver sharirPnueli effectWCon effectWNCon solverConSideRR solverConSideWNRR interactive oracleSolver topDown \
	multithread compose mCP access varEq symbLocks thread threadEscape constraints \
	base region owner unit mutex osek osektransactionality uninit stackTrace stackTrace2 \
	malloc_null memLeaks contain shapes mTFlag report need

TEST_MODULES = testutils generalArrayTest nativeArrayDomainTest \
	intDomainTest mapDomainTest collapsingArrayDomainTest \
	pMapArrayDomainTest lMapArrayDomainTest solverTest


MODULES    = $(PROG_MODULES) maingoblint $(TEST_MODULES) mainTest


oldall : oldopt

# ECHOSTYLE_SCOTT=1
# PROFILE=1
# DEBUG=1
# STATIC=1
UNSAFE=1
include Makefile.ocaml



oldbyte  : $(PROG_MODULES:%=$(OBJDIR)/%.cmo) $(OBJDIR)/maingoblint.cmo
	@$(NARRATIVE) "Linking $(COMPILETOWHAT) goblint.byte$(EXE) $(LINKMSG)"
	$(AT)$(CAMLLINK.BYTE) -g -o goblint.byte$(EXE) \
                    $(LINK_LIBS:%=%.cma) \
                    $^

oldopt   : $(PROG_MODULES:%=$(OBJDIR)/%.cmx) $(OBJDIR)/maingoblint.cmx
	@$(NARRATIVE) "Linking $(COMPILETOWHAT) goblint$(EXE) $(LINKMSG)"
	$(AT)$(CAMLLINK.OPT) -o goblint$(EXE) \
                    $(LINK_LIBS:%=%.cmxa) \
                    $^

oldunittests  : $(PROG_MODULES:%=$(OBJDIR)/%.cmx) \
			$(TEST_MODULES:%=$(OBJDIR)/%.cmx) \
			$(OBJDIR)/mainTest.cmx
	@$(NARRATIVE) "Linking $(COMPILETOWHAT) goblint.unittest $(LINKMSG)"
	$(AT)$(CAMLLINK.OPT) -o goblint.unittest \
                    $(LINK_LIBS:%=%.cmxa) \
                    oUnit.cmxa \
                    $^

# Clean up
oldclean: cleancaml
	@rm -f goblint goblint.exe goblint.byte goblint.byte.exe
	@rm -f goblint.unittest
	@find ./obj '(' -name "*.cm[iox]" -or -name "*.o" ')' -exec rm '{}' ';'
	@rm -f tests/*.i tests/*.goblint tests/a.out a.out
#	@rm -f src/version.ml src/config.ml

oldtest: opt unittests
	@./scripts/runalltests.sh


# TAGS
oldtags:
	otags -vi $(SOURCEDIRS:%=%*) $(CIL)/src/* $(CIL)/src/frontc/* $(CIL)/src/ext/* $(CIL)/ocamlutil/*

# DOCS
DOC_ARG = -I $(OBJDIR) \
	-I +batteries -I $(CILLIB) -I $(XML) $(SOURCEDIRS:%=-I %) `find src/ -regex '.*\.mli*'` \
	$(CIL)src/cil.mli $(CIL)src/formatcil.mli \
	$(CIL)ocamlutil/pretty.mli $(CIL)ocamlutil/errormsg.mli \
	$(CIL)ocamlutil/trace.mli $(CIL)ocamlutil/stats.mli \
	$(CIL)ocamlutil/alpha.mli $(CIL)ocamlutil/util.mli \
	$(CIL)ocamlutil/clist.mli \
	$(XML)/xml.mli \

olddocs: 
	@rm -rf doc && mkdir doc
	$(OCAMLDOC) $(DOCFLAGS) $(DOC_ARG)

olddot:
	ocamldoc.opt -dot-reduce -dot -v $(DOC_ARG)
